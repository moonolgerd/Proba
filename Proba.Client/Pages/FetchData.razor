@page "/fetchdata"
@using Google.Protobuf.WellKnownTypes;
@inject ProbaServer.ProbaServerClient ProbaServerClient
@inject IModalService Modal

<h1>Sortable HTML table</h1>
<BlazoredModal />
@if (data != null)
{
    <table class="table">
        <thead>
            <tr>
                <th class="header" @onclick="@(() => Click("Greeting"))">
                    Greeting
                    <span class="@SortHelper.ClassForColumn("Greeting")"></span>
                </th>
                <th class="header" @onclick="@(() => Click("Age"))">
                    Age
                    <span class="@SortHelper.ClassForColumn("Age")"></span>
                </th>
                <th class="header" @onclick="@(() => Click("Date"))">
                    Date
                    <span class="@SortHelper.ClassForColumn("Date")"></span>
                </th>
                <th class="header" @onclick="@(() => Click("Percentage"))">
                    Percentage
                    <span class="@SortHelper.ClassForColumn("Percentage")"></span>
                </th>
            </tr>
        </thead>
        @foreach (var item in data)
        {
            <tbody>
                <tr>
                    <td>@item.Greeting</td>
                    <td>@item.Count</td>
                    <td>@item.Date.ToDateTime()</td>
                    <td>@item.Value</td>
                    <td><span class="oi oi-circle-x" @onclick="@(() => Remove(@item))"></span></td>
                </tr>
            </tbody>
        }
    </table>
}
<input type="button" title="Add" @onclick="@Add" value="Add a Greeting" />

@functions {
    List<ProbaMessage> data = new List<ProbaMessage>();
    bool?[] sortIndices;

    protected override async Task OnInitAsync()
    {
        await GetData();

        sortIndices = SortHelper.Indices;

        //await channel.ShutdownAsync();
    }

    private async Task GetData()
    {
        data.Clear();
        using (var reply = ProbaServerClient.GetProbas(new ProbaRequest()))
        {
            while (await reply.ResponseStream.MoveNext())
            {
                var current = reply.ResponseStream.Current;
                foreach (var item in current.Messages)
                {
                    data.Add(item);
                }
            }
        }
    }

    public async Task Remove(ProbaMessage probaMessage)
    {
        await ProbaServerClient.DeleteProbaAsync(probaMessage);
        data.Remove(probaMessage);
        await GetData();
    }

    public async Task Add()
    {
        Modal.Show("Add a Proba", typeof(AddProba));
        Modal.OnClose += async (ModalResult result) => await GetData();
    }

    public void Click(string columnName)
    {
        Func<ProbaMessage, object> func;

        switch (columnName)
        {
            case "Greeting":
                func = (item) => item.Greeting;
                break;
            case "Age":
                func = (item) => item.Count;
                break;
            case "Date":
                func = (item) => item.Date;
                break;
            case "Percentage":
            default:
                func = (item) => item.Value;
                break;
        }

        if (!SortHelper.Indices[SortHelper.IndexForColumn(columnName)].HasValue)
        {
            SortHelper.Indices[SortHelper.IndexForColumn(columnName)] = false;
        }
        else if (!SortHelper.Indices[SortHelper.IndexForColumn(columnName)].GetValueOrDefault())
        {
            data.OrderBy(func);
            SortHelper.Indices[SortHelper.IndexForColumn(columnName)] = true;
        }
        else
        {
            data.OrderByDescending(func);
            SortHelper.Indices[SortHelper.IndexForColumn(columnName)] = null;
        }
    }

    static class SortHelper
    {
        public static bool?[] Indices { get; } = new bool?[] { null, null, null, null };

        public static string ClassForColumn(string columnName)
        {
            var index = IndexForColumn(columnName);
            var ascending = Indices[index];

            if (ascending.HasValue)
            {
                if (!ascending.Value)
                {
                    return "oi oi-caret-bottom";
                }
                else
                {
                    return "oi oi-caret-top";
                }
            }
            else
            {
                return string.Empty;
            }
        }

        public static int IndexForColumn(string columnName)
        {
            switch (columnName)
            {
                case "Greeting":
                    return 0;
                case "Age":
                    return 1;
                case "Date":
                    return 2;
                case "Percentage":
                default:
                    return 3;
            }
        }
    }
}
